name: Reusable Bootstrap Infrastructure

on:
  workflow_call:
    inputs:
      auto_bootstrap:
        description: 'Whether to auto bootstrap'
        required: true
        default: false
        type: boolean
    secrets:
      ANSIBLE_HOSTS:
        required: true
      ANSIBLE_USER:
        required: false
      ANSIBLE_HOSTS_PASSWORD:  # For initial bootstrap
        required: false
      SSH_PRIVATE_KEY:  # For post-bootstrap
        required: false
      SSH_KNOWN_HOSTS:  # Optional override
        required: false

jobs:
  bootstrap:
    if: ${{ inputs.auto_bootstrap == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout templates repo for local actions
        uses: actions/checkout@v4
        with:
          repository: SkiesGames/SkiesDota-CI-CD-Templates
          path: templates

      - name: Setup Docker
        uses: ./templates/.github/actions/setup-docker

      - name: Generate Inventory
        env:
          ANSIBLE_HOSTS: ${{ secrets.ANSIBLE_HOSTS }}
          ANSIBLE_USER: ${{ secrets.ANSIBLE_USER }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e ANSIBLE_HOSTS \
            -e ANSIBLE_USER \
            ghcr.io/skiesgames/skiesdota-ci-cd-templates/ansible-prod:latest \
            bash -c "
              ansible-playbook /workspace/templates/ansible/playbooks/generate_initial_inventory.yml
            "

      - name: Run Bootstrap Playbook
        env:
          ANSIBLE_HOSTS: ${{ secrets.ANSIBLE_HOSTS }}
          ANSIBLE_USER: ${{ secrets.ANSIBLE_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}  
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e ANSIBLE_HOSTS \
            -e ANSIBLE_USER \
            -e SSH_PRIVATE_KEY \
            -e SSH_KNOWN_HOSTS \  
            ghcr.io/skiesgames/skiesdota-ci-cd-templates/ansible-prod:latest \
            bash -c "
              cd ansible &&
              ansible-playbook -i /workspace/inventory.ini playbooks/bootstrap.yml --verbose
            " 