name: Cluster CI/CD Cache Maintenance
on:
  schedule:
    - cron: '0 4 * * 0' # Every Sunday at 4:00 AM
  workflow_dispatch:

jobs:
  cleanup-nodes:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Kubectl
        uses: azure/setup-kubectl@v3

      - name: Write Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy Janitor DaemonSet
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: cache-janitor
            namespace: arc-runners
            labels:
              app: cache-janitor
          spec:
            selector:
              matchLabels:
                app: cache-janitor
            template:
              metadata:
                labels:
                  app: cache-janitor
              spec:
                nodeSelector:
                  role: ci-runner
                containers:
                - name: janitor
                  image: alpine:latest
                  securityContext:
                    privileged: true
                  command: ["/bin/sh", "-c"]
                  args:
                    - |
                      echo "Starting cleanup on node..."
                      
                      if [ -d /cache-mount ]; then
                        echo "Cache directory found. Nuking contents..."
                        # Delete all files/folders inside, but keep the root folder
                        find /cache-mount -mindepth 1 -delete
                        echo "Cleanup complete."
                      else
                        echo "No cache directory found (is hostPath correct?). Skipping."
                      fi
                      
                      # Sleep forever so the pod stays 'Running' until we delete the DaemonSet
                      sleep infinity
                  volumeMounts:
                  - name: runner-cache
                    mountPath: /cache-mount
                volumes:
                - name: runner-cache
                  hostPath:
                    path: /opt/arc-runner-cache
                    type: DirectoryOrCreate
          EOF

      - name: Wait for Cleanup to Finish
        run: |
          echo "Waiting for janitors to deploy on all nodes..."
          kubectl rollout status daemonset/cache-janitor -n arc-runners --timeout=60s
          
          # Give them 30 seconds to actually run the 'rm -rf' command
          echo "Letting them scrub the disk..."
          sleep 30

      - name: Remove Janitor
        if: always()
        run: |
          echo "Removing Janitor DaemonSet..."
          kubectl delete daemonset cache-janitor -n arc-runners --ignore-not-found=true