---
- name: Prepare MongoDB Environment
  hosts: localhost
  connection: local
  become: true
  tasks:
    - name: Ensure Docker is running and accessible
      ansible.builtin.command: docker ps
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Fail if Docker is not available
      ansible.builtin.fail:
        msg: "Docker is not available or not running. Check Docker socket permissions."
      when: docker_check.rc != 0

    - name: Create necessary directories for MongoDB
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/mongodb_data
        - /tmp/mongodb_logs

    - name: Start MongoDB container
      ansible.builtin.docker_container:
        name: mongodb
        image: mongo:7.0
        state: started
        ports:
          - "27017:27017"
        command: mongod --replSet rs0 --bind_ip_all --dbpath /data/db
        restart_policy: unless-stopped
        env:
          MONGO_INITDB_DATABASE: test
        volumes:
          - /tmp/mongodb_data:/data/db
        ulimits:
          - "nofile:64000:64000"

    - name: Wait for MongoDB to be ready
      ansible.builtin.wait_for:
        port: 27017
        timeout: 30
        delay: 5

    - name: Set replica set configuration
      ansible.builtin.set_fact:
        mongo_hosts:
          - "{{ ansible_default_ipv4.address }}:27017"
          - "{{ ansible_default_ipv4.address }}:27018"
          - "{{ ansible_default_ipv4.address }}:27019" 