---
- name: Deploy Kubernetes Operators to K3s Cluster
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Install CloudNativePG CRDs
      ansible.builtin.command: >
        kubectl apply --server-side --force-conflicts -f https://github.com/cloudnative-pg/cloudnative-pg/releases/download/v1.27.1/cnpg-1.27.1.yaml
      register: cnpg_apply_result
      retries: 3
      delay: 5
      until: cnpg_apply_result.rc == 0
      failed_when: false
      changed_when: cnpg_apply_result.rc == 0

    - name: Wait for CloudNativePG operator
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: cnpg-system
        name: cnpg-controller-manager
      register: cnpg_deployment
      until: cnpg_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Install RabbitMQ Cluster Operator
      ansible.builtin.command: >
        kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
      register: rabbitmq_operator_result
      retries: 3
      delay: 5
      until: rabbitmq_operator_result.rc == 0
      failed_when: false
      changed_when: rabbitmq_operator_result.rc == 0

    - name: Wait for RabbitMQ Operator pod
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: rabbitmq-system
      register: rabbitmq_operator_pods
      until: >
        rabbitmq_operator_pods.resources |
        selectattr('metadata.name', 'match', '.*rabbitmq.*operator.*') |
        selectattr('status.phase', 'equalto', 'Running') |
        list | length > 0
      retries: 30
      delay: 10
    
    - name: Install MinIO Operator
      ansible.builtin.command: >
        kubectl apply --kustomize https://github.com/minio/operator.git/resources?ref=v7.1.1
      register: minio_operator_install
      retries: 3
      delay: 5
      until: minio_operator_install.rc == 0
      failed_when: false
      changed_when: minio_operator_install.rc == 0

    - name: Wait for MinIO Operator deployment
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: minio-operator
        name: minio-operator
      register: minio_deployment
      until: minio_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10