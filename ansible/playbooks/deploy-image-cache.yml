---
- name: Deploy Image Cache Infrastructure
  hosts: all
  gather_facts: false
  tasks:
    - name: Run Deployment on Controller
      run_once: true
      delegate_to: localhost
      block:
        - name: Fetch kubeconfig from primary K3s server using cat
          ansible.builtin.command: cat /etc/rancher/k3s/k3s.yaml
          register: kubeconfig_raw
          delegate_to: "{{ groups['all'][0] }}"
          become: true
          changed_when: false
          vars:
            ansible_python_interpreter: auto_silent

        - name: Get primary server IP
          ansible.builtin.set_fact:
            primary_server_ip: "{{ groups['all'][0] }}"

        - name: Fix kubeconfig (replace 127.0.0.1 with server IP)
          ansible.builtin.set_fact:
            kubeconfig_content: "{{ kubeconfig_raw.stdout | regex_replace('127.0.0.1', primary_server_ip) }}"

        - name: Save corrected kubeconfig to local file
          ansible.builtin.copy:
            content: "{{ kubeconfig_content }}"
            dest: /tmp/k3s-config.yaml
            mode: '0600'

        - name: Set KUBECONFIG_PATH fact
          ansible.builtin.set_fact:
            kubeconfig_path: /tmp/k3s-config.yaml

        # --- Docker Registry Infrastructure ---
        - name: Create image-cache namespace
          kubernetes.core.k8s:
            kubeconfig: "{{ kubeconfig_path }}"
            definition:
              apiVersion: v1
              kind: Namespace
              metadata:
                name: image-cache

        - name: Create PVC for Docker Registry
          kubernetes.core.k8s:
            kubeconfig: "{{ kubeconfig_path }}"
            definition:
              apiVersion: v1
              kind: PersistentVolumeClaim
              metadata:
                name: registry-storage
                namespace: image-cache
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  requests:
                    storage: 10Gi
                storageClassName: local-path

        - name: Deploy Docker Registry
          kubernetes.core.k8s:
            kubeconfig: "{{ kubeconfig_path }}"
            definition:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: registry
                namespace: image-cache
              spec:
                replicas: 1
                selector:
                  matchLabels:
                    app: registry
                template:
                  metadata:
                    labels:
                      app: registry
                  spec:
                    containers:
                      - name: registry
                        image: registry:2
                        ports:
                          - containerPort: 5000
                        env:
                          - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY
                            value: "/var/lib/registry"
                        volumeMounts:
                          - name: registry-storage
                            mountPath: /var/lib/registry
                        resources:
                          requests:
                            memory: "256Mi"
                            cpu: "100m"
                          limits:
                            memory: "512Mi"
                            cpu: "500m"
                    volumes:
                      - name: registry-storage
                        persistentVolumeClaim:
                          claimName: registry-storage

        - name: Create ClusterIP Service for Registry
          kubernetes.core.k8s:
            kubeconfig: "{{ kubeconfig_path }}"
            definition:
              apiVersion: v1
              kind: Service
              metadata:
                name: registry
                namespace: image-cache
              spec:
                selector:
                  app: registry
                ports:
                  - port: 5000
                    targetPort: 5000
                type: ClusterIP

        # --- Docker Config Secret for GHCR Authentication ---
        - name: Get GitHub credentials from environment
          ansible.builtin.set_fact:
            github_username: "{{ lookup('env', 'GITHUB_USERNAME') }}"
            github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
          no_log: true

        - name: Create Docker config secret for GHCR authentication
          kubernetes.core.k8s:
            kubeconfig: "{{ kubeconfig_path }}"
            definition:
              apiVersion: v1
              kind: Secret
              metadata:
                name: docker-config
                namespace: image-cache
              type: kubernetes.io/dockerconfigjson
              data:
                .dockerconfigjson: "{{ ({'auths': {'ghcr.io': {'username': github_username, 'password': github_token}}}) | to_json | b64encode }}"
          no_log: true
          when: github_username is defined and github_token is defined

        # --- Image Warmer CronJob ---
        - name: Deploy Image Warmer CronJob
          kubernetes.core.k8s:
            kubeconfig: "{{ kubeconfig_path }}"
            definition:
              apiVersion: batch/v1
              kind: CronJob
              metadata:
                name: image-warmer
                namespace: image-cache
              spec:
                schedule: "*/1 * * * *"  # Every 1 minute
                jobTemplate:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: warmer
                            image: quay.io/skopeo/stable:latest
                            command:
                              - /bin/sh
                              - -c
                              - |
                                set -e
                                # Sync the ansible-prod image from GHCR to local registry
                                skopeo copy --dest-tls-verify=false \
                                  docker://ghcr.io/skiesgames/skiesdota-ci-cd-templates/ansible-prod:latest \
                                  docker://registry.image-cache.svc.cluster.local:5000/ansible-prod:latest

                                # Also sync the :latest tag
                                skopeo copy --dest-tls-verify=false \
                                  docker://ghcr.io/skiesgames/skiesdota-ci-cd-templates/ansible-prod:latest \
                                  docker://registry.image-cache.svc.cluster.local:5000/ansible-prod:latest
                            volumeMounts:
                              - name: docker-config
                                mountPath: /root/.docker/
                                readOnly: true
                            resources:
                              requests:
                                memory: "256Mi"
                                cpu: "100m"
                              limits:
                                memory: "512Mi"
                                cpu: "500m"
                        volumes:
                          - name: docker-config
                            secret:
                              secretName: docker-config
                              items:
                                - key: .dockerconfigjson
                                  path: config.json
                        restartPolicy: OnFailure
