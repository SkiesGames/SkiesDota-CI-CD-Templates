---
- name: Deploy GitHub Actions Runner for Organization
  hosts: all
  gather_facts: false
  tasks:
    - name: Run Deployment on Controller
      run_once: true
      delegate_to: localhost
      block:
        - name: Fetch kubeconfig from primary K3s server using cat
          ansible.builtin.command: cat /etc/rancher/k3s/k3s.yaml
          register: kubeconfig_raw
          delegate_to: "{{ groups['all'][0] }}"
          become: true
          changed_when: false
          vars:
            ansible_python_interpreter: auto_silent

        - name: Get primary server IP
          ansible.builtin.set_fact:
            primary_server_ip: "{{ groups['all'][0] }}"

        - name: Fix kubeconfig (replace 127.0.0.1 with server IP)
          ansible.builtin.set_fact:
            kubeconfig_content: "{{ kubeconfig_raw.stdout | regex_replace('127.0.0.1', primary_server_ip) }}"

        - name: Save corrected kubeconfig to local file
          ansible.builtin.copy:
            content: "{{ kubeconfig_content }}"
            dest: /tmp/k3s-config.yaml
            mode: '0600'

        - name: Set KUBECONFIG_PATH fact
          ansible.builtin.set_fact:
            kubeconfig_path: /tmp/k3s-config.yaml

        # --- Runner Scale Set Deployment ---
        - name: Get organization name from environment
          ansible.builtin.set_fact:
            runner_organization: "{{ lookup('env', 'GITHUB_ORGANIZATION') }}"

        - name: Install Actions Runner Controller
          kubernetes.core.helm:
            name: arc
            chart_ref: oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
            release_namespace: "arc-runners"
            create_namespace: true
            wait: true
            timeout: 5m
            kubeconfig: "{{ kubeconfig_path }}"

        - name: Install Runner Scale Set
          kubernetes.core.helm:
            name: arc-runner-set
            chart_ref: oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set
            release_namespace: "arc-runners"
            create_namespace: true
            wait: true
            timeout: 5m
            kubeconfig: "{{ kubeconfig_path }}"
            set_values:
              - value: "githubConfigUrl=https://github.com/{{ runner_organization }}"
              - value: "githubConfigSecret.github_app_id={{ lookup('env', 'GITHUB_APP_ID') }}"
              - value: "githubConfigSecret.github_app_installation_id={{ lookup('env', 'GITHUB_APP_INSTALLATION_ID') }}"
              - value: "githubConfigSecret.github_app_private_key={{ lookup('env', 'GITHUB_APP_PRIVATE_KEY') }}"
              - value: "containerMode.type=dind"
              - value: "minRunners=1"
              - value: "maxRunners=1"
          no_log: true