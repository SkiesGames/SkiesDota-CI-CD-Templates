.base_molecule:
  stage: test
  image: $CI_REGISTRY_IMAGE/ansible-test:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
    # Fix permission issues
    ANSIBLE_LOCAL_TMP: "/tmp/.ansible/tmp"
    ANSIBLE_REMOTE_TMP: "/tmp/.ansible/tmp"
    # Performance improvements
    ANSIBLE_PIPELINING: "true"
    ANSIBLE_FACT_CACHING: "memory"
  before_script:
    - !reference [.test_common_before_script]
  script:
    - molecule test
  after_script:
    - !reference [.test_common_after_script]
  rules:
    - changes:
        - Dockerfile.test
      when: always
      needs:
        - build_test_image
    - changes:
        - ansible/roles/${MOLECULE_ROLE_NAME}/**/*
      when: always
      needs: []
    - when: manual
      needs: []

test_mongodb:
  extends: .base_molecule
  variables:
    MOLECULE_ROLE_NAME: mongodb
